// =======================================================
//          חלק 2: כל הלוגיקה של האפליקציה (גרסה סופית)
// =======================================================
let participants = [];
let admin = false;
let editId = null;

const ToastManager = {
    show: (message, type = 'success') => {
        const container = document.getElementById('toast-container');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => { toast.remove(); }, 3500);
    }
};

const map = L.map('map').setView([31.5, 34.75], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const markers = L.markerClusterGroup();
map.addLayer(markers);

const modernMarkerIcon = L.divIcon({ className: 'modern-marker', html: `<div style="width:36px;height:36px;background:linear-gradient(135deg, #6366f1, #8b5cf6);border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:3px solid white;box-shadow:0 6px 16px rgba(99,102,241,0.5);display:flex;align-items:center;justify-content:center;position:relative;"><div style="width:16px;height:16px;background:white;border-radius:50%;transform:rotate(45deg);"></div></div>`, iconSize: [36, 36], iconAnchor: [18, 36], popupAnchor: [0, -36] });

async function loadDataFromFirestore() {
    try {
        console.log("🔥 טוען נתונים עדכניים מ-Firestore...");
        const snapshot = await db.collection("participants").get();
        const fetchedParticipants = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            const firstName = data['שם פרטי'] || '';
            const lastName = data['שם משפחה'] || '';
            fetchedParticipants.push({
                id: doc.id, firstName, lastName,
                name: `${firstName} ${lastName}`.trim(),
                city: data['עיר'] || 'לא צוין',
                phone: data['מספר טלפון'] || '',
                whatsapp: data['מספר ווטצאפ'] || '',
                lat: data['Lat'],
                lon: data['Lon']
            });
        });
        // זה התיקון הקריטי: אנחנו דורסים את המערך הישן, לא מוסיפים אליו
        participants = fetchedParticipants;
        renderMarkers();
        console.log(`✅ סנכרון הושלם. סה"כ ${participants.length} משתתפים.`);
    } catch (error) {
        console.error("❌ שגיאה בסנכרון נתונים:", error);
        ToastManager.show("שגיאה בסנכרון הנתונים", "error");
    }
}

function renderMarkers(list = participants) {
    markers.clearLayers();
    document.getElementById('participant-count').textContent = `${list.length} משתתפים`;

    function getDistance(lat1, lon1, lat2, lon2) {
        if (!lat1 || !lon1 || !lat2 || !lon2) return Infinity;
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    list.forEach(p => {
        if (!p.lat || !p.lon) return;

        const nearbyParticipant = participants.find(other => p.id !== other.id && getDistance(p.lat, p.lon, other.lat, other.lon) < 20);
        
        const whatsappNum = p.whatsapp || p.phone;
        const message = encodeURIComponent(`היי ${p.name}, רוצה לתאם נסיעה משותפת?`);
        
        let carpoolButton = '';
        if (nearbyParticipant && typeof whatsappNum === 'string' && whatsappNum.length > 0) {
            const carpoolMessage = encodeURIComponent(`היי, ראיתי שאנחנו גרים קרוב. רוצה לתאם נסיעה משותפת למשלחת של מאיה?`);
            carpoolButton = `<a href="https://wa.me/972${whatsappNum.replace(/^0/,'')}?text=${carpoolMessage}" class="popup-btn carpool" target="_blank" style="background: #374151; grid-column: 1 / -1;">הצע נסיעה משותפת</a>`;
        }

        let whatsappButton = '';
        if (typeof whatsappNum === 'string' && whatsappNum.length > 0) {
            whatsappButton = `<a href="https://wa.me/972${whatsappNum.replace(/^0/,'')}?text=${message}" class="popup-btn whatsapp" target="_blank">שלח הודעה</a>`;
        }
        
        const popupContent = `<div class="popup-box"><div class="popup-name">${p.name}</div><div class="popup-city">${p.city}</div><div class="popup-phone">📞 ${p.phone}</div><div class="popup-btns"><a href="tel:${p.phone}" class="popup-btn phone" target="_blank">חייג</a>${whatsappButton}${carpoolButton}${admin ? `<button class="popup-btn edit" onclick="editUser('${p.id}')">ערוך</button><button class="popup-btn delete" onclick="deleteUser('${p.id}')">מחק</button>` : ''}</div></div>`;
        L.marker([p.lat, p.lon], { icon: modernMarkerIcon }).bindPopup(popupContent).addTo(markers);
    });
}

// שאר הפונקציות (editUser, deleteUser, geocodeCity) נשארות זהות לקוד הקודם

window.editUser = (id) => { /* ... קוד קיים ... */ };
window.deleteUser = async (id) => { /* ... קוד קיים ... */ };
async function geocodeCity(city) { /* ... קוד קיים ... */ };

document.addEventListener('DOMContentLoaded', () => {
    // לוגיקת טעינה חד-פעמית ונקייה
    loadDataFromFirestore();

    auth.onAuthStateChanged(user => {
        admin = !!user;
        document.getElementById('admin-login-btn').style.display = admin ? 'none' : 'flex';
        document.getElementById('admin-logout-btn').style.display = admin ? 'flex' : 'none';
        document.getElementById('add-user-btn').style.display = admin ? 'block' : 'none';
        renderMarkers();
    });

    // שאר המאזינים לאירועים נשארים זהים
    document.getElementById('admin-login').addEventListener('click', async () => { /* ... קוד קיים ... */ });
    document.getElementById('user-save').addEventListener('click', async () => { /* ... קוד קיים ... */ });
    /* ... וכל שאר המאזינים ... */
});

// העתק לכאן את הפונקציות המלאות והמאזינים מהקוד הקודם שהיה כמעט מושלם
